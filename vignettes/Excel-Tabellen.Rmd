---
title: "Excel-Tabellen"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Excel-Tabellen}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Allgemeine Informationen

Das `statR` Package enthält Funktionen zur schnellen Erzeugung von Microsoft 
Excel-Dateien mithilfe des [openxlsx](https://github.com/awalker89/openxlsx) 
Pakets. Die Voreinstellungen orientieren sich am Corporate Design vom 
Statistischen Amt Kanton Zürich, Anwender können diese Voreinstellungen aber
auch an ihre Bedürfnisse anpassen. Entweder, indem sie Anpassungen in den
Eingabeargumenten der Funktionen vornehmen, oder indem sie eine eigene 
Konfiguration anlegen.

Diese Vignette bietet einen Überblick der wichtigsten Funktionen in diesem
Paket sowie einen Leitfaden zur Handhabung von Nutzerkonfigurationen.


## Funktionen und Beispiele

### quickXLSX() 
Die Funktion `quickXLSX()` bietet die einfachste Möglichkeit, in R eine 
Excel-Datei mit einem Datensatz zu erzeugen. Die Output-Datei besteht aus einem
einzelen Arbeitsblatt, wahlweise mit einem Header mit Kontaktangaben, Titel,
Quelle und Metadaten.

```{r, echo = TRUE, eval = FALSE}
quickXLSX(data = mtcars, 
          file = "motor_trend_car_road_tests",
          title = "Motor trend car road tests", 
          source = paste0("Henderson and Velleman (1981). Building multiple ",
                          "regression models interactively. ",
                          "Biometrics, 37, 391–411.",
          metadata = paste0("The data was extracted from the 1974 Motor Trend ",
                            "US magazine and comprises fuel consumption and ",
                            "10 aspects of automobile design and performance ",
                            "for 32 automobiles (1973–74 models).")
)
```

### aXLSX()

Mit der Funktion `aXLSX()` kann ein einzelner Datensatz aus `R` als 
vorformatierte XLSX-Datei exportiert werden. Die Funktion hat zum Ziel, 
möglichst __barrierefreie__ Excel-Tabellen zu erstellen, die sich auch für die 
Publikation auf [zh.ch](zh.ch) eignen 
(siehe: https://statistikzh.github.io/axguide/grafiken.html#components). Dazu
werden Daten und Metadateninformationen in separate Arbeitsblätter abgefüllt. 

Das erste Arbeitsblatt beinhaltet einen Titel, eine Quellenangabe und die Daten, 
das zweite Arbeitsblatt Hinweise zu den Daten sowie Kontaktinformationen. 
Mit dem Argument `author` kann vermerkt werden, wer die Datei erstellt hat. Per 
Default werden die Initialen bzw. letzten zwei Ziffern des hinterlegten 
Benutzernamens eingefügt.

```{r, echo = TRUE, eval = FALSE}
aXLSX(data = mtcars,
      file = "motor_trend_car_road_tests",
      title = "Motor trend car road tests",
      source = paste0("Henderson and Velleman (1981). ", 
                      "Building multiple regression models interactively. ",
                      "Biometrics, 37, 391–411."),
      metadata = paste0("The data was extracted from the 1974 Motor ",
                        "Trend US magazine and comprises fuel consumption ",
                        "and 10 aspects of automobile design and performance ",
                        "for 32 automobiles (1973–74 models).")
)
```

<!-- ![Screenshot des Datenblatts in der Datei motor_trend_car_road_tests.xlsx](./output-aXLSX-1.PNG){width=95%} -->

<!-- ![Screenshot des Metadatenblatts der Datei motor_trend_car_road_tests.xlsx](./output-aXLSX-2.PNG){width=95%} -->


### splitXLSX()

Mit der Funktion `splitXLSX()` kann ein Datensatz aus R anhand eines Merkmals
aufgespalten und über mehrere Arbeitsblätter verteilt weren. Die Funktion ist 
besonders dann geeignet, wenn die Variable eine begrenzte Anzahl von 
Ausprägungene hat, die intuitive Bedeutungen haben (zB. Altersklassen, Jahre
oder Regionen).

```{r,echo = TRUE, eval = FALSE}
splitXLSX(data = mtcars,
          file = "motor_trend_car_road_tests",
          sheetvar = "cyl",
          title = "Motor trend car road tests",
          source = paste0("Henderson and Velleman (1981), Building multiple ",
                          "regression models interactively. ",
                          "Biometrics, 37, 391–411."),
          metadata = paste0("The data was extracted from the 1974 Motor Trend ",
                            "US magazine and comprises fuel consumption and ",
                            "10 aspects of automobile design and performance ",
                            "for 32 automobiles (1973–74 models).")
)
```

<!-- ![Screenshot der Datei motor_trend_car_road_tests.xlsx](./output-splitXLSX.PNG){width=95%} -->

### datasetsXLSX()

Die Funktion \code{datasetsXLSX()} ermöglicht komplexere Exporte mit mehreren 
Datensätzen und/oder Grafiken (unterstützt sind ggplot-Objekte und Pfadangaben
zu Bild-Dateien). Die Datensätze und Grafiken werden dabei als Liste im 
Funktionsargument `datasets` übergeben.

```{r, echo = TRUE, eval = FALSE}
dat1 <- mtcars
dat2 <- PlantGrowth

datasetsXLSX(file = "twoDatasets",
             datasets = list(mtcars, PlantGrowth),
             sheetname = c("Autos","Blumen"),
             titles = c("mtcars-Datensatz", "PlantGrowth-Datensatz"),
             source = c(
               paste0("Henderson and Velleman (1981). Building multiple ",
                      "regression models interactively. ",
                      "Biometrics, 37, 391–411."),
               paste0("Dobson, A. J. (1983) An Introduction to Statistical ",
                      "Modelling. London: Chapman and Hall.")
             ),
             metadata = c("Bemerkungen zum mtcars-Datensatz: x", 
                          "Bemerkungen zum PlantGrowth-Datensatz: x")
)
```

Zu beachten gilt es hier, dass die Anzahl der Datensätze sowie die der weiteren
Argumente (Titel, Quellen, etc.) übereinstimmen müssen. Für besonders komplexe
Exporte besteht aber ferner die Möglichkeit, diese im Voraus zu konfigurieren.
Diese Funktionalität wird durch die Funktionen `add_sheetname`, `add_title`, 
`add_source`, etc. bereitgestellt. 

```{r, echo = TRUE, eval = FALSE}
library(dplyr)
library(ggplot2)

# Load data and assign attributes in one pipeline
df <- mtcars %>%
  add_sheetname("Cars") %>%
  add_title("Motor Trend Car Road Tests") %>%
  add_source(
    c("Henderson and Velleman (1981),",
      "Building multiple regression models interactively.",
      "Biometrics, 37, 391–411.")) %>%
  add_metadata(
    c("The data was extracted from the 1974 Motor",
      "Trend US magazine and comprises fuel consumption",
      "and 10 aspects of automobile design and",
      "performance for 32 automobiles (1973–74 models)."))

# Create a plot and assign attributes in one pipeline
plt <- (ggplot(mtcars) +
  geom_histogram(aes(x = hp))) %>%
    add_sheetname("PS") %>%
    add_title("Histogram of horsepower") %>%
    add_plot_height(3) %>%
    add_plot_width(6)


# Generate outputfile using minimal call
datasetsXLSX(
  file = tempfile(fileext = ".xlsx"),
  datasets = list(df, plt))
```


Beim Einbinden von Bild-Dateien gilt es letztlich zu beachten, dass die 
Bild-Grösse vom Benutzer festgelegt werden muss. Anders als bei ggplot-Objekten 
können eingebundene Bild-Dateien verzerrt wirken, wenn die Höhe und Breite 
falsch gesetzt werden. Die Input-Argumente plot_width und plot_height
sind etwas flexibler als die übrigen Argumente. Valide Eingaben sind:
* NULL (keine)
muss entweder der Anzahl Plots, der Anzahl von Objekten in datasets, 1 oder NULL
sein. 

<!-- ![Screenshot des Titelblatts der Datei twoDatasets.xlsx](./output-datasetsXLSX-1.PNG){width=95%} -->

<!-- ![Screenshot des ersten Blatts der Datei twoDatasets.xlsx](./output-datasetsXLSX-2.PNG){width=95%} -->


### Visuelle Gruppierung von Spalten
Mit dem Argument `grouplines` können in Datensätzen vertikale Linien eingefügt 
werden, um bestimmte Spalten visuell zu gruppieren. Dazu müssen im Argument 
entweder der Spaltennamen oder Spalten-Nr. der Spalten angegeben werden, bei 
denen eine neue Gruppe anfängt. 

Ferner können für diese Gruppen noch zusätzliche Überschriften erstellt werden.
Dazu müssen im Argument `group_names` die Überschriftentitel angegeben werden.


### Zeilentrennung für Quellen oder Metadaten
![Microsoft Excel bietet keine Möglichkeit, die Zeilenhöhe von verbundenen Zellen automatisch anzupassen](https://support.microsoft.com/en-us/topic/you-cannot-use-the-autofit-feature-for-rows-or-columns-that-contain-merged-cells-in-excel-34b54dd7-9bfc-6c8f-5ee3-2715d7db4353). 

Entsprechend kann es zu Darstellungsproblemen kommen, wenn der Input für die Argumente `metadata` oder `source` zu lange ist. In solchen Fällen muss die Zeilenhöhe manuell angepasst werden. Alternativ kann man die Zeilenumbrüche manuell vorzunehmen, indem man den Text über mehrere Vektorelemente verteilt (Beispiel: `c("Text Zeile 1, "Text Zeile 2", "Text Zeile 3")`.


### Formatierung von Spalteninhalten
Die Spalteninhalte können bei allen Funktionen entsprechend ihrer Einheit 
formatiert werden, indem pro Variablennamen die `class` festlegt wird. 
Mit `class(data$variable1) <- "percentage"` können die Werte der `variable1` 
(reichen von 0 bis 1) als Prozent mit Prozentzeichen ausgegeben werden. 

Weblinks können mit `class(data$variable2) <- "hyperlink"` aufrufbar gemacht 
werden und mit `class(data$variable3) <- "scientific"` können Zahlen in der 
wissenschaftlichen Notation dargestellt werden.


## User Configurations

### Funktionen

Die Funktion \code{initUserConfigStore()} dient dazu, das Verzeichnis mit dem
Index der Konfigurationen anzulegen. Im Ursprungszustand enthält dieser Index
eine einzelne Konfiguration, das Default file. Weitere Konfigurationen können
mit der Funktion \code{addUserConfig()} angelegt und mit der Funktion
\code{removeUserConfig()} entfernt werden. Zwischen Konfigurationen wechseln 
kann man mit der Funktion \code{loadUserConfig}.

Die Konfigurationen sind Text-Dateien im YAML-Format. Jeder Eintrag enthält ein
Schlüsselwort sowie den zugehörigen Wert. Nach dem Einlesen der Datei werden die
Einträge in den R Optionen (\code{options()}) hinterlegt, womit die Einträge für
die Dauer der Session verfügbar bleiben.

