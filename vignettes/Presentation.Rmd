---
title: "Untitled"
author: "Thomas Fischer"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(statR)
library(dplyr)
library(ggplot2)
library(hatools)
```


# statR Version update


## user configs --  
```{r}
# config files: YAML files located in extdata folder
statR::getUserConfigs()

# contents: 
readLines("../inst/extdata/config/default")


# read a defined user config
statR::readUserConfig(name = "statzh")

# get active config
statR::getActiveConfigName()


```

### Main issues: 
what happens at package version upgrade?
* Custom files may be overwritten?
* Defaults to default
* Behavior will change in predictable ways
* Could do with a simple way to export the config file

What happens at R version upgrade?
* Patch version upgrades: nothing
* Major and minor version upgrades: package store changes. Defaults to default


# The tools


## quickXLSX

```{r, eval = FALSE}
quickXLSX(
  file,
  data,
  title,
  source = getOption("statR_source"),
  metadata,
  logo = getOption("statR_logo"),
  contactdetails = inputHelperContactInfo(compact = TRUE),
  author = "user",
  grouplines = NA,
  group_names = NA
)
```
```{r}
title <- "Motor trend car road tests"
source <- paste(
  "Henderson and Velleman (1981). Building",
  "multiple regression models interactively.",
  "Biometrics, 37, 391–411.")
metadata <- paste(
  "The data was extracted from the 1974 Motor",
  "Trend US magazine and comprises fuel consumption",
  "and 10 aspects of automobile design and",
  "performance for 32 automobiles (1973–74 models).")

quickXLSX(file = "quickXLSX_test",
          data = mtcars,
          title = title,
          source = source,
          metadata = metadata,
          grouplines = c(4, 8),
          group_names = c("Group 1", "Group 2"))
```


# aXLSX


```{r, eval = FALSE}
aXLSX(
  file,
  data,
  title = "Title",
  source = getOption("statR_source"),
  metadata = NA,
  logo = getOption("statR_logo"),
  contactdetails = inputHelperContactInfo(),
  author = "user",
  grouplines = NA,
  group_names = NA
)
```

```{r}
title <- "Motor trend car road tests"
source <- paste(
  "Henderson and Velleman (1981). Building",
  "multiple regression models interactively.",
  "Biometrics, 37, 391–411.")
metadata <- paste(
  "The data was extracted from the 1974 Motor",
  "Trend US magazine and comprises fuel consumption",
  "and 10 aspects of automobile design and",
  "performance for 32 automobiles (1973–74 models).")

aXLSX(file = "aXLSX_test",
      data = mtcars,
      title = title,
      source = source,
      metadata = metadata,
      grouplines = c(4, 8),
      group_names = c("Group 1", "Group 2"))
```



## splitXLSX 

Changes:
* Now directly based on datasetsXLSX. 
* Sheetnames are based on factor levels of sheetvar
* Source and metadata are mirrored for all factor levels of sheetvar.
* Title is mirrored, and factor level is appended.

```{r, eval = FALSE}
splitXLSX(
  file,
  data,
  sheetvar,
  title = "Titel",
  source = getOption("statR_source"),
  metadata = NA,
  logo = getOption("statR_logo"),
  contactdetails = inputHelperContactInfo(compact = TRUE),
  homepage = getOption("statR_homepage"),
  author = "user",
  grouplines = NA,
  group_names = NA
)
```

```{r}
title <- "Motor trend car road tests"
source <- paste(
  "Henderson and Velleman (1981). Building",
  "multiple regression models interactively.",
  "Biometrics, 37, 391–411.")
metadata <- paste(
  "The data was extracted from the 1974 Motor",
  "Trend US magazine and comprises fuel consumption",
  "and 10 aspects of automobile design and",
  "performance for 32 automobiles (1973–74 models).")

splitXLSX(
  file = "splitXLSX_test",
  data = mtcars,
  sheetvar = "cyl",
  title = title,
  source = source,
  metadata = metadata,
  grouplines = c(5,8),
  group_names = c("Group 1", "Group 2")
)
```

#datasetsXLSX

Changes: 
* Extensively reworked. 
* Most arguments which were previously required to be set can now be left empty (receiving defaults)
* When left empty, datasetsXLSX tries to find values in objects contained in datasets.
* Can use pipelines for setting sheetnames, titles, sources, etc. up in advance: `add_sheetname`, `add_title`, etc. 
* Plots are now inserted in the order in which they are provided in datasets.
* Can also add a title, source, or metadata (by user request)
* metadata_sheet: defined by a list(title = ..., source = ..., text = ...).

Directions for future development:
* Extend the new method, allowing more user customization


Issues to consider:
* inputHelperContactInfo() is not exported. The argument contactdetails remains so it
  can be overridden at will, but the function itself is innaccessible to users.
* Can't do anything about linewrapping not working in merged cells (where they'd matter
  most). Microsoft treats this as "feature, not a bug".
* Some sheetnames can cause Excel to detect corruption. This usually relates to sheetnames
  starting on digits or containing special characters. Sheetnames are used to label named
  regions.
* Should all named regions be dropped, or should those for data be retained?
  
```{r, eval = FALSE}
datasetsXLSX(
  file,
  datasets,
  sheetnames,
  titles,
  sources,
  metadata,
  grouplines,
  group_names,
  plot_widths = 6,
  plot_heights = 3,
  index_title = getOption("statR_toc_title"),
  index_source = getOption("statR_source"),
  logo = getOption("statR_logo"),
  contactdetails = inputHelperContactInfo(),
  homepage = getOption("statR_homepage"),
  openinghours = getOption("statR_openinghours"),
  auftrag_id = NULL,
  metadata_sheet = NULL,
  overwrite = FALSE
)
```

## Old method

```{r}
# Example with two datasets and one figure - legacy method
fig <- ggplot2::ggplot(mtcars, ggplot2::aes(x = disp))+
                 ggplot2::geom_histogram()

datasetsXLSX(
  file = "datasetsXLSX_test1",
  datasets = list(mtcars, PlantGrowth, fig),
  titles = c("mtcars-Datensatz", "PlantGrowth-Datensatz", "Histogramm"),
  plot_widths = c(5),
  plot_heights = c(5),
  sources = list(
    paste("Source: Henderson and Velleman (1981).",
          "Building multiple regression models",
          "interactively. Biometrics, 37, 391–411."),
    paste("Source: Dobson, A. J. (1983) An Introduction",
          "to Statistical Modelling.",
          "London: Chapman and Hall."),
    NULL),
  metadata = list(
    "Bemerkungen zum mtcars-Datensatz: x",
    "Bemerkungen zum PlantGrowth-Datensatz: x",
    NULL),
  sheetnames = c("Autos","Blumen", "Histogramm"),
  index_title = "Autos und Pflanzen",
  auftrag_id = "A2021_0000",
  overwrite = TRUE)
```


## New method

```{r}
df <- mtcars %>%
  add_sheetname("Autos") %>%
  add_title("mtcars-Datensatz") %>%
  add_source(paste("Henderson and Velleman (1981). Building multiple",
                   "regression models interactively.",
                   "Biometrics, 37, 391–411."),
    prefix = "Source: ", collapse = "") %>%
  add_metadata("Bemerkungen zum mtcars-Datensatz: x", prefix = "Hinweis: ", 
               collapse = "") %>%
  add_grouplines(c(4,8)) %>%
  add_group_names(c("Group1", "Group2"))

df2 <- PlantGrowth %>%
  add_sheetname("Blumen") %>%
  add_title("PlantGrowth-Datensatz") %>%
  add_source(paste(
                "Source: Dobson, A. J. (1983) An Introduction",
                "to Statistical Modelling.",
                "London: Chapman and Hall.")) %>% 
  
  add_metadata("Bemerkungen zum PlantGrowth-Datensatz: x")

plt <- (ggplot(mtcars) + geom_histogram(aes(x = cyl))) %>%
  add_sheetname("Histogram") %>%
  add_title("A histogram") %>%
  add_source("mtcars data from R package 'datasets'",
    prefix = "Datenquelle:", collapse = " ") %>%
  add_plot_width(5) %>%
  add_plot_height(5)

a_png <- "map.png" %>% 
  add_sheetname("A map") %>% 
  add_plot_width(5) %>% 
  add_plot_height(5)
  

datasetsXLSX(
  file = "datasetsXLSX_test2",
  datasets = list(df,  df2, plt, a_png),
  metadata_sheet = list(
    title = "Title of the metadata sheet",
    source = "Source shown on metadata sheet",
    text = c("The metadatasheet is intended for universally applicable",
      "long-form explanations which don't fit neatly above the data.",
      "",
      "Each element is printed in a new row.")
  ), overwrite = TRUE)
```


# Example hatools
Quickly combine various outputs from hatools.

```{r}
statop <- statools::con_statdb()

efh <- get_efh(statop, "gde", 1, zeitraum = 2017:2023)
mfh <- get_mfh(statop, "gde", 1, zeitraum = 2017:2023)
stw <- get_stw(statop, "gde", 1, zeitraum = 2017:2023)

datasets <- list(efh, mfh, stw) %>% 
  lapply(
    function(data) calc_ha_statistik(data, auswertungs_kat = c("Zeitraum"), pool = 5, moving_average = TRUE)
  )

datasetsXLSX(
  file = "hatools_example",
  sheetnames = c("EFH", "MFH", "STW"),
  datasets = datasets
)

wbl <- get_wohnbauland(statop, "kanton", 1000, zeitraum = 1985:2023, ohne_abbruch = TRUE) %>% 
  calc_ha_statistik(auswertungs_kat = c("Jahr"), pool = 1)

```


# Example bevprog

```{r}
library(bevprog)

dat <- get_bevprog_data(statop, 1, c("gde", "bezirk", "kanton"), gewuenschte_jahre = 2020:2050)

plt <- create_bevpyr(statop, "20", c("gde"), 1, jahre = c(2010, 2020, 2030, 2040), group = "both")




datasetsXLSX(
  file = "bevprog_example",
  datasets = c(dat, plt),
  sheetnames = c("gde", "bezirk", "kanton", "plt_gde"),
  plot_widths = 5, plot_heights = 5,
  overwrite = TRUE
)

```

